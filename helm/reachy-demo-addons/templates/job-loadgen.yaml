{{- if .Values.loadgen.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "reachy-demo-addons.fullname" . }}-loadgen
spec:
  schedule: {{ .Values.loadgen.schedule | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: loadgen
              image: {{ .Values.loadgen.image | quote }}
              env:
                - name: AIM_BASE_URL
                  value: {{ .Values.aim.baseUrl | quote }}
                - name: AIM_CHAT_PATH
                  value: {{ .Values.aim.chatPath | quote }}
                - name: AIM_MODEL
                  value: {{ .Values.aim.model | quote }}
                {{- if .Values.loadgen.apiKey.enabled }}
                - name: AIM_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.loadgen.apiKey.secretName | quote }}
                      key: {{ .Values.loadgen.apiKey.secretKey | quote }}
                {{- end }}
                - name: DURATION_SECONDS
                  value: {{ .Values.loadgen.durationSeconds | quote }}
                - name: CONCURRENCY
                  value: {{ .Values.loadgen.concurrency | quote }}
                - name: QPS_PER_WORKER
                  value: {{ .Values.loadgen.qpsPerWorker | quote }}
                - name: TIMEOUT_SECONDS
                  value: {{ .Values.loadgen.timeoutSeconds | default 30 | quote }}
              command: ["sh","-c"]
              args:
                - |
                  pip install -q requests && python -c "
                  import os, time, json, threading, statistics, requests, random, sys
                  base=os.environ["AIM_BASE_URL"].rstrip("/")
                  path=os.environ.get("AIM_CHAT_PATH","/v1/chat/completions")
                  model=os.environ.get("AIM_MODEL","llm-prod")
                  api_key=os.environ.get("AIM_API_KEY","").strip()
                  dur=int(os.environ.get("DURATION_SECONDS","60"))
                  conc=int(os.environ.get("CONCURRENCY","8"))
                  qps=float(os.environ.get("QPS_PER_WORKER","1"))
                  timeout=float(os.environ.get("TIMEOUT_SECONDS","30"))
                  prompts=json.loads(open("/prompts/prompts.json","r").read())
                  url=base + (path if path.startswith("/") else "/" + path)
                  headers={"Content-Type":"application/json"}
                  if api_key:
                      headers["Authorization"]=f"Bearer {api_key}"
                  lat=[]
                  errors=0
                  lock=threading.Lock()
                  stop=time.time()+dur
                  interval=1.0/max(0.1,qps)

                  def worker(i):
                      nonlocal errors
                      while time.time()<stop:
                          prompt=random.choice(prompts)
                          payload={"model":model,"messages":[{"role":"user","content":prompt}],"temperature":0.2,"max_tokens":140,"stream":False}
                          t0=time.perf_counter()
                          try:
                              r=requests.post(url, json=payload, headers=headers, timeout=timeout)
                              if r.status_code<400:
                                  dt=(time.perf_counter()-t0)*1000.0
                                  with lock: lat.append(dt)
                              else:
                                  with lock: errors+=1
                          except requests.Timeout:
                              with lock: errors+=1
                          except Exception as e:
                              with lock: errors+=1
                          time.sleep(interval)

                  threads=[threading.Thread(target=worker,args=(i,),daemon=True) for i in range(conc)]
                  for t in threads: t.start()
                  for t in threads: t.join()

                  if not lat:
                      print(f"ERROR: No successful requests. {errors} errors occurred. Check AIM_BASE_URL and endpoint accessibility.")
                      sys.exit(2)
                  lat.sort()
                  def pct(p): return lat[int(p*(len(lat)-1))]
                  print(f"requests={len(lat)} successful, {errors} errors, p50={pct(0.50):.0f}ms p95={pct(0.95):.0f}ms mean={statistics.mean(lat):.0f}ms url={url}")
                  "
              volumeMounts:
                - name: prompts
                  mountPath: /prompts
          volumes:
            - name: prompts
              configMap:
                name: {{ include "reachy-demo-addons.fullname" . }}-prompts
{{- end }}
